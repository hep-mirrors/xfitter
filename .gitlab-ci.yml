image: "gitlab-registry.cern.ch/fitters/xfitter"

before_script:
  - yum -y install yum-plugin-ovl which yaml-cpp-devel libyaml-devel gsl-devel cmake3 automake libtool zlib zlib-devel zlib-static ceres-solver-devel
  #eigen3-devel gflags-devel glog-devel
  - ln -s /usr/bin/cmake3 /usr/bin/cmake 
  
job-install-minimal:
  only: 
    - merge_requests
    - schedules
  script: 
    - ./make.sh install
  variables:
    CMAKE_FLAGS: "-DCMAKE_DISABLE_FIND_PACKAGE_ROOT=TRUE" 

job-install-full:
  only: 
    - merge_requests
    - schedules
  timeout: 120m
  script: 
    #- yum -y install gcc-gfortran git tar root libgfortran-static
    - yum -y install git tar root
    - ./tools/install-xfitter deps
    - . setup.sh
    # for the next command the output is redirected, to see it (in case of problems) uncomment the command below which will print it
    - ./tools/download-lhapdf.sh HERAPDF20_NNLO_EIG HERAPDF20_NNLO_VAR CT14nlo CT14nnlo ABMP16_3_nlo ABMP16_5_nnlo HERAPDF20_NLO_FF3B_EIG NNPDF30_nlo_as_0118 NNPDF31_nlo_as_0118_hessian NNPDF31_nnlo_as_0118 MMHT2014nnlo68cl nCTEQ15FullNuc_184_74 nCTEQ15FullNuc_1_1 >& download-lhapdf.log
    - cat *.log
    - ./make.sh install
    - git clone https://gitlab.cern.ch/fitters/xfitter-datafiles.git temp-datafiles
    - mv temp-datafiles/.git datafiles/.git
    - rm -rf temp-datafiles
    - cd datafiles
    - git reset --hard HEAD
    - cd -
    - ./tools/test.sh
  artifacts:
    when: on_failure
    paths:
      - install.log
      - temp/**/test.log
      - temp/**/xfitter.log
      - temp/**/output
    expire_in: 2 day

job-ceres-fit:
  only: 
    - merge_requests
    - schedules
  script: 
    - ./tools/install-qcdnum
    - ./tools/install-numdiff
    #- ./tools/install-ceres
    - . setup.sh
    - ./make.sh install
    - ./tools/test.sh CERES-fit
  variables:
    CMAKE_FLAGS: "-DCMAKE_DISABLE_FIND_PACKAGE_ROOT=TRUE" 
  artifacts:
    when: on_failure
    paths:
      - install.log
      - temp/**/test.log
      - temp/**/xfitter.log
      - temp/**/output
    expire_in: 2 day

job-ceres-parallel:
  only: 
    - merge_requests
    - schedules
  script: 
    - ./tools/install-qcdnum
    - ./tools/install-numdiff
    #- ./tools/install-ceres
    - . setup.sh
    - ./make.sh install
    - ./tools/test.sh CERES-parallel
  variables:
    CMAKE_FLAGS: "-DCMAKE_DISABLE_FIND_PACKAGE_ROOT=TRUE" 
  artifacts:
    when: on_failure
    paths:
      - install.log
      - temp/**/test.log
      - temp/**/xfitter.log
      - temp/**/output
    expire_in: 2 day

job-scanmin:
  only: 
    - merge_requests
    - schedules
  script: 
    - ./tools/install-qcdnum
    - ./tools/install-numdiff
    - . setup.sh
    - ./make.sh install
    - ./tools/test.sh scanmin
  variables:
    CMAKE_FLAGS: "-DCMAKE_DISABLE_FIND_PACKAGE_ROOT=TRUE" 
  artifacts:
    when: always
    paths:
      - install.log
      - temp/**/test.log
      - temp/**/xfitter.log
      - temp/**/output
    expire_in: 2 day
